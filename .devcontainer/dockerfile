# Use official Python image as base
FROM python:3.12-slim-bookworm

# Avoid tz/locale prompts during install
ENV DEBIAN_FRONTEND=noninteractive
# Make sure uv is on PATH after install
ENV PATH="/root/.local/bin:${PATH}"

# System packages that help with HTTPS, downloading, and Playwright's deps script
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
      curl ca-certificates git \
 && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    wget \
    git \
    jq \
    zip \
    build-essential \
    ca-certificates \
    sudo \
    && apt-get clean

RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get update && apt-get install -y nodejs

RUN sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin


# 1) Install uv (Astral)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# App directory
WORKDIR /app

# Copy only requirements first to leverage Docker layer caching
COPY requirements.txt .

# 2) Install Python deps via uv pip
# (default behavior creates a .venv that `uv run` will use)
RUN uv pip install -r requirements.txt

# 3) Install Playwright + Chromium and system deps
# --with-deps will install missing Debian packages needed by Chromium
RUN uvx playwright install chromium --with-deps --no-shell

# Copy the rest of the project
COPY ./data_adapter .

# (Optional) point Playwright to a predictable cache path
ENV PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright

# If you use a Gemini API key, pass it at runtime:
#   docker run -e GEMINI_API_KEY=... image
# CMD runs your scraper as requested
CMD ["uv", "run", "scrapping_module/run.py"]

RUN npm install -g zx

COPY requirements.txt* /tmp/
RUN if [ -f /tmp/requirements.txt ]; then pip3 install --no-cache-dir -r /tmp/requirements.txt; fi

RUN echo "devcontainer" >> /root/.ergosign-project
